FROM python:3.11-slim
RUN pip install --upgrade pip

# Set environment
ENV PYTHONPATH=/app
WORKDIR /app

# Copy only requirements first
COPY retrieval/requirements.txt ./retrieval/requirements.txt

# Install dependencies (cached as long as requirements.txt doesn't change)
RUN pip install --no-cache-dir -r retrieval/requirements.txt

# Install locales
RUN apt-get update && \
    apt-get install -y --no-install-recommends locales && \
    # Generate Norwegian Bokm√•l
    sed -i '/nb_NO.UTF-8/s/^# //' /etc/locale.gen && \
    locale-gen nb_NO.UTF-8 && \
    rm -rf /var/lib/apt/lists/*

# Set environment variables so Python sees it
ENV LANG=nb_NO.UTF-8
ENV LANGUAGE=nb_NO.UTF-8
ENV LC_ALL=nb_NO.UTF-8

# Copy app code after dependencies
COPY utils utils
COPY retrieval retrieval
COPY ingestion/knowledge ingestion/knowledge

# Now switch to retrieval dir for running
WORKDIR /app/retrieval
EXPOSE 8080
RUN chmod +x start.sh
CMD ["./start.sh"]
